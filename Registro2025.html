<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro2025</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        main {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: auto;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border: 2px solid #2c3e50;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #2c3e50;
        }
        th {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #2c3e50;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            transform: scale(1.2);
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.eliminar {
            background-color: #e74c3c;
        }
        button.eliminar:hover {
            background-color: #c0392b;
        }
        .controles {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .version-mensaje {
            background: #2ecc71;
            color: white;
            padding: 16px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .alerta {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
            text-align: center;
        }
        .alerta.exito {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alerta.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .instrucciones {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            border: 1px solid #ffeeba;
        }
        .instrucciones p {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        .instrucciones p:before {
            content: "•";
            position: absolute;
            left: 5px;
        }
    </style>
</head>
<body>
    <main>
        <section id="asistenciaSection">
            <h2>Registro2025</h2>
            <div id="alertaContainer" class="alerta"></div>
            <div class="controles">
                <button onclick="agregarFila()">Agregar estudiante</button>
                <button onclick="guardarDatos()">Guardar datos</button>
                <button onclick="exportarDatos()">Exportar lista</button>
                <button onclick="descargarPlantilla()">Descargar plantilla vacía</button>
                <input type="file" id="inputFile" accept=".xlsx" style="display: none;" onchange="cargarPlantilla(this)">
                <button onclick="document.getElementById('inputFile').click()">Cargar lista desde archivo (.xlsx)</button>
                <button onclick="limpiarDatos()" class="eliminar">Limpiar todo</button>
            </div>
            <div class="instrucciones">
                <p>1. Descarga la plantilla vacía haciendo clic en "Descargar plantilla vacía".</p>
                <p>2. Ábrela con Excel o cualquier editor de hojas de cálculo.</p>
                <p>3. Modifica o elimina los ejemplos incluidos.</p>
                <p>4. Llena la plantilla con los datos de tus estudiantes.</p>
                <p>5. Guarda el archivo como Excel (.xlsx).</p>
                <p>6. Usa el botón "Cargar lista desde archivo Excel (.xlsx)" para importar la lista de estudiantes.</p>
            </div>
            <div id="asistenciaContainer"></div>
        </section>
    </main>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const maxEstudiantes = 50;
        let dias = [
            { fecha: '', nombre: 'Día 1' },
            { fecha: '', nombre: 'Día 2' },
            { fecha: '', nombre: 'Día 3' },
            { fecha: '', nombre: 'Día 4' },
            { fecha: '', nombre: 'Día 5' }
        ];
        let estudiantes = [];
        const VERSION = '2.1';
        const STORAGE_KEY = 'registroAsistencia_v2';
        const plantillaEjemplo = [
            { cedula: "207890123", nombre: "Juan", apellido1: "Pérez", apellido2: "González", asistenciaDias: Array(dias.length).fill('') },
            { cedula: "208901234", nombre: "María", apellido1: "Rodríguez", apellido2: "López", asistenciaDias: Array(dias.length).fill('') },
            { cedula: "209012345", nombre: "Carlos", apellido1: "Sánchez", apellido2: "Jiménez", asistenciaDias: Array(dias.length).fill('') }
        ];
        function cargarDatosGuardados() {
            const datosGuardados = localStorage.getItem(STORAGE_KEY);
            if (datosGuardados) {
                estudiantes = JSON.parse(datosGuardados);
                mostrarAlerta('Datos cargados correctamente', 'exito');
            }
        }
        function renderAsistencia() {
            let html = '<div class="version-mensaje">Sistema de registro de asistencia - Versión ' + VERSION + '</div>';
            html += '<button onclick="agregarDia()" style="margin-bottom:10px;">+ Agregar día</button>';
            html += '<table><thead>';
            html += '<tr>' +
                '<th rowspan="2">#</th>' +
                '<th rowspan="2">Cédula</th>' +
                '<th rowspan="2">Nombre</th>' +
                '<th rowspan="2">Primer apellido</th>' +
                '<th rowspan="2">Segundo apellido</th>' +
                `<th colspan="${dias.length}">Asistencia por día</th>` +
                '<th rowspan="2">Acciones</th>' +
            '</tr>';
            html += '<tr>';
            for (let d = 0; d < dias.length; d++) {
                html += `<th><input type="date" value="${dias[d].fecha}" onchange="actualizarFechaDia(${d}, this.value)" style="width:110px;">`;
                html += `<br><span style="font-size:12px;">${dias[d].nombre}</span></th>`;
            }
            html += '</tr></thead><tbody>';
            for (let i = 0; i < estudiantes.length; i++) {
                const estudiante = estudiantes[i];
                html += `<tr>
                    <td>${i + 1}</td>
                    <td><input type="text" value="${estudiante.cedula || ''}" onchange="actualizarEstudiante(${i}, 'cedula', this.value)" placeholder="Número de cédula"></td>
                    <td><input type="text" value="${estudiante.nombre || ''}" onchange="actualizarEstudiante(${i}, 'nombre', this.value)" placeholder="Nombre"></td>
                    <td><input type="text" value="${estudiante.apellido1 || ''}" onchange="actualizarEstudiante(${i}, 'apellido1', this.value)" placeholder="Primer apellido"></td>
                    <td><input type="text" value="${estudiante.apellido2 || ''}" onchange="actualizarEstudiante(${i}, 'apellido2', this.value)" placeholder="Segundo apellido"></td>
                    `;
                for (let d = 0; d < dias.length; d++) {
                    html += `<td><select onchange="actualizarAsistenciaDia(${i}, ${d}, this.value)">
                        <option value="" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === '') ? 'selected' : ''}></option>
                        <option value="Ausente" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === 'Ausente') ? 'selected' : ''}>Ausente</option>
                        <option value="Tarde" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === 'Tarde') ? 'selected' : ''}>Tarde</option>
                        <option value="Espadada" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === 'Espadada') ? 'selected' : ''}>Espadada</option>
                        <option value="1" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === '1') ? 'selected' : ''}>1</option>
                        <option value="2" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === '2') ? 'selected' : ''}>2</option>
                        <option value="3" ${(estudiante.asistenciaDias && estudiante.asistenciaDias[d] === '3') ? 'selected' : ''}>3</option>
                    </select></td>`;
                }
                html += `<td><button class="eliminar" onclick="eliminarFila(${i})">Eliminar</button></td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('asistenciaContainer').innerHTML = html;
        }
        function mostrarAlerta(mensaje, tipo) {
            const alertaContainer = document.getElementById('alertaContainer');
            alertaContainer.textContent = mensaje;
            alertaContainer.className = `alerta ${tipo}`;
            alertaContainer.style.display = 'block';
            setTimeout(() => {
                alertaContainer.style.display = 'none';
            }, 3000);
        }
        function agregarFila() {
            if (estudiantes.length >= maxEstudiantes) {
                mostrarAlerta('Se ha alcanzado el máximo de 50 estudiantes.', 'error');
                return;
            }
            estudiantes.push({ cedula: '', nombre: '', apellido1: '', apellido2: '', asistenciaDias: Array(dias.length).fill('') });
            renderAsistencia();
            mostrarAlerta('Estudiante agregado correctamente', 'exito');
            guardarDatos();
        }
        function agregarDia() {
            const nuevoDia = { fecha: '', nombre: `Día ${dias.length + 1}` };
            dias.push(nuevoDia);
            // Actualizar asistenciaDias en cada estudiante
            estudiantes.forEach(est => {
                if (!est.asistenciaDias) est.asistenciaDias = [];
                est.asistenciaDias.push('');
            });
            renderAsistencia();
            guardarDatos();
        }

        function actualizarFechaDia(idxDia, valor) {
            dias[idxDia].fecha = valor;
            guardarDatos();
        }
        function actualizarAsistenciaDia(idxEstudiante, idxDia, valor) {
            if (!estudiantes[idxEstudiante].asistenciaDias) {
                estudiantes[idxEstudiante].asistenciaDias = Array(dias.length).fill('');
            }
            estudiantes[idxEstudiante].asistenciaDias[idxDia] = valor;
            guardarDatos();
        }
        function eliminarFila(idx) {
            if (confirm('¿Está seguro de eliminar este estudiante?')) {
                estudiantes.splice(idx, 1);
                renderAsistencia();
                guardarDatos();
                mostrarAlerta('Estudiante eliminado correctamente', 'exito');
            }
        }
        function actualizarEstudiante(idx, campo, valor) {
            estudiantes[idx][campo] = valor;
            guardarDatos();
        }
        function guardarDatos() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(estudiantes));
            mostrarAlerta('Datos guardados correctamente', 'exito');
        }
        function limpiarDatos() {
            if (confirm('¿Está seguro de eliminar todos los datos? Esta acción no se puede deshacer.')) {
                estudiantes = [];
                localStorage.removeItem(STORAGE_KEY);
                renderAsistencia();
                mostrarAlerta('Todos los datos han sido eliminados', 'exito');
            }
        }
        function exportarDatos() {
            if (estudiantes.length === 0) {
                mostrarAlerta('No hay datos para exportar', 'error');
                return;
            }
            const csvRows = [];
            const headers = ['Cédula', 'Nombre', 'Primer apellido', 'Segundo apellido'];
            dias.forEach((dia, idx) => {
                headers.push(`${dia.nombre}${dia.fecha ? ' (' + dia.fecha + ')' : ''}`);
            });
            csvRows.push(headers.join(','));
            estudiantes.forEach((estudiante) => {
                const row = [
                    `"${estudiante.cedula}"`,
                    `"${estudiante.nombre}"`,
                    `"${estudiante.apellido1}"`,
                    `"${estudiante.apellido2}"`
                ];
                for (let d = 0; d < dias.length; d++) {
                    row.push(`"${(estudiante.asistenciaDias && estudiante.asistenciaDias[d]) || ''}"`);
                }
                csvRows.push(row.join(','));
            });
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const fecha = new Date().toLocaleDateString().replace(/\//g, '-');
            link.href = URL.createObjectURL(blob);
            link.download = `registro-asistencia-${fecha}.csv`;
            link.click();
            mostrarAlerta('Datos exportados correctamente', 'exito');
        }
        function descargarPlantilla() {
            // Generar plantilla en formato Excel (.xlsx) con columnas para cada día
            const headers = ['Cédula', 'Nombre', 'Primer apellido', 'Segundo apellido'];
            dias.forEach((dia, idx) => {
                headers.push(`${dia.nombre}${dia.fecha ? ' (' + dia.fecha + ')' : ''}`);
            });
            let datos = [];
            // Ejemplos
            for (let j = 0; j < plantillaEjemplo.length; j++) {
                const ejemplo = plantillaEjemplo[j];
                let fila = {
                    'Cédula': ejemplo.cedula,
                    'Nombre': ejemplo.nombre,
                    'Primer apellido': ejemplo.apellido1,
                    'Segundo apellido': ejemplo.apellido2
                };
                for (let d = 0; d < dias.length; d++) {
                    fila[headers[4 + d]] = '';
                }
                datos.push(fila);
            }
            // 20 filas vacías
            for (let i = 0; i < 20; i++) {
                let fila = {
                    'Cédula': '',
                    'Nombre': '',
                    'Primer apellido': '',
                    'Segundo apellido': ''
                };
                for (let d = 0; d < dias.length; d++) {
                    fila[headers[4 + d]] = '';
                }
                datos.push(fila);
            }
            // Crear hoja y libro
            const ws = XLSX.utils.json_to_sheet(datos, { header: headers });
            // Agregar bordes a cada celda
            const range = XLSX.utils.decode_range(ws['!ref']);
            for(let R = range.s.r; R <= range.e.r; ++R) {
                for(let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({r:R, c:C});
                    if(ws[cell_address]) {
                        if(!ws[cell_address].s) ws[cell_address].s = {};
                        ws[cell_address].s.border = {
                            top: {style: "thin", color: {rgb: "2c3e50"}},
                            bottom: {style: "thin", color: {rgb: "2c3e50"}},
                            left: {style: "thin", color: {rgb: "2c3e50"}},
                            right: {style: "thin", color: {rgb: "2c3e50"}}
                        };
                    }
                }
            }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla');
            // Descargar archivo como .xlsx (moderno)
            XLSX.writeFile(wb, 'plantilla_estudiantes.xlsx');
            mostrarAlerta('Plantilla Excel descargada correctamente', 'exito');
        }
        function cargarPlantilla(input) {
            const file = input.files[0];
            if (file) {
                const extension = file.name.split('.').pop().toLowerCase();
                if (extension !== 'xlsx') {
                    mostrarAlerta('Solo se permite cargar archivos Excel (.xlsx)', 'error');
                    return;
                }
                // Leer archivo Excel
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
                    const encabezados = rows[0].map(h => h.toLowerCase());
                    const idxCedula = encabezados.findIndex(h => h.includes('cédula'));
                    const idxNombre = encabezados.findIndex(h => h.includes('nombre'));
                    const idxApellido1 = encabezados.findIndex(h => h.includes('primer apellido'));
                    const idxApellido2 = encabezados.findIndex(h => h.includes('segundo apellido'));
                    const nuevosEstudiantes = rows.slice(1)
                        .map(cols => ({
                            cedula: cols[idxCedula] ? String(cols[idxCedula]).trim() : '',
                            nombre: cols[idxNombre] ? String(cols[idxNombre]).trim() : '',
                            apellido1: cols[idxApellido1] ? String(cols[idxApellido1]).trim() : '',
                            apellido2: cols[idxApellido2] ? String(cols[idxApellido2]).trim() : '',
                            asistencia: false,
                            fecha: new Date().toISOString().split('T')[0]
                        }))
                        .filter(est => est.cedula || est.nombre || est.apellido1 || est.apellido2);
                    if (nuevosEstudiantes.length > maxEstudiantes) {
                        mostrarAlerta(`La lista excede el máximo de ${maxEstudiantes} estudiantes`, 'error');
                        return;
                    }
                    estudiantes = nuevosEstudiantes;
                    guardarDatos();
                    renderAsistencia();
                    mostrarAlerta('Lista de estudiantes cargada correctamente', 'exito');
                };
                reader.readAsArrayBuffer(file);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosGuardados();
            renderAsistencia();
        });
    </script>
</body>
</html>
